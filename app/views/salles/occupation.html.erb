<div class="page-header">
  <h1>
    <span class="glyphicon glyphicon-blackboard"></span>
    Occupation des salles
  </h1>
</div>

<div class='container-fluid'>
    <%= form_tag request.path, method: :get do %>
      <div class="form-group">
        <div class="row">

          <div class="col-sm-2">
            <%= label_tag "Date" %>    
            <%= text_field_tag :start_date, params[:start_date], type:'date', onchange:'this.form.submit()', class:"form-control" %>
          </div>

          <div class="col-sm-2">
            <%= label_tag "Salle" %>
              <div class="input-group">
                <%= select_tag :salle_id, 
                        options_from_collection_for_select(Salle.order(:nom), :id, :nom, params[:salle_id]), 
                          include_blank:true, onchange:'this.form.submit()', class:"form-control" %>
                <span class="input-group-btn">
                  <%= submit_tag 'Filtrer', class:"btn btn-success" %>
                </span>
              </div>
          </div>
        </div>
      </div>  
    <% end %>
</div>

<div class="table-responsive">
  <table class="table table-hover table-striped">
    <thead>
      <tr>
        <th>Salle</th>
        <th>Places</th>
        <th>Cours</th>
        <th>Formation</th>
        <% Cour.etendue_horaire.each_with_index do |heure, index| %>
          <th><%= heure %>h</th>
          <% if [4,10].include?(index) %><th /><% end %>
        <% end %>
      </tr>
    </thead>
    <tfoot>
      <tr>
        <% 21.times do %><th /><% end %>
      </tr>
    </tfoot>

    <tbody>
      <% bloc = 'A' %>
      <% @salles.each do |salle| %>
        <% if @date %>
          <% @cours = Cour.confirmé.where("salle_id = ? AND cours.debut BETWEEN DATE(?) AND DATE(?)", salle.id, @date, @date + 1.day).order(:debut) %>
        <% else %>
          <% @cours = salle.cours %>
        <% end %>
        <% @formations = @cours.select(:formation_id).uniq.pluck(:formation_id) %>

        <% if bloc != salle.nom[0] %>
          <% bloc = salle.nom[0] %>
          <thead>
            <tr>
              <th />
              <th />
              <th />
              <th />
              <% Cour.etendue_horaire.each_with_index do |heure, index| %>
                <th><%= heure %>h</th>
                <% if [4,10].include?(index) %><th /><% end %>
              <% end %>
            </tr>
          </thead>
        <% end %>

        <tr>
          <td><b><%= salle.nom %></b></td>
          <td><%= salle.places %></td>
          <td><%= link_to_unless @cours.count.zero?, @cours.count, cours_path(ids:@cours.pluck(:id), view:'list') %>
          </td>
          <td>
              <% @formations.each do |id| %>
                <% formation = Formation.find(id) %>
                <span style="background-color:<%= formation.color %>;padding-left: 7px;"></span>
                <span style="padding-left:5px;"></span>
                <%= formation.abrg %>
                <span style="padding-right:10px;"></span>
              <% end %>
          </td>

          <% if @date %>
            <% range = [] %>
            <% @cours.each {|cours| range += cours.range } %>
            
            <% map = Cour.etendue_horaire.map {|i| range.include?(i) ? 'red' : 'lightgreen' } %>
            
            <% map.each_with_index do |color, index| %>
              <td>
                <% if color == 'lightgreen' %>
                  <%= link_to new_cour_path(debut:@date, heure:(index + 8), salle_id:salle.id, from:'occupation') do %>
                    <span style="background-color:<%= color %>;padding-left: 15px;"></span>
                  <% end %>
                <% else %>
                  <span style="background-color:<%= color %>;padding-left: 15px;"></span> 
                <% end %>
              </td>
              <% if [4,10].include?(index) %><td /><% end %>
            <% end %>
          <% else %>
            <% 18.times do %><td /><% end %>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>

  <% if user_signed_in? %>
    <div class="row">
      <div class="col-sm-6">
        <h4>
          Heures de cours planifiées: <%= @nombre_heures_cours %>h <br>
          Heures de salles disponibles: <%= @heures_dispo_salles %>h
           (<%= @salles_dispo.count %> salles * 8h)<br>
        </h4>
      </div>
      <div class="col-sm-6">
        <h3>
          Taux d'occupation: <%= @taux_occupation.to_i %>%
        </h3>
      </div>
    </h4>
  </div>
<% end %>
<br>

