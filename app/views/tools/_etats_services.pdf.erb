<% cours_ids = @cours.where(intervenant: intervenant).order(:debut).pluck(:id) %>
<% cours_ids << @cours.where(intervenant_binome: intervenant).order(:debut).pluck(:id) %>
<% cours_ids = cours_ids.flatten %>

<div class="page-header"> 
    <h3><%= intervenant.nom_prenom %><br>
        Du <%= l(@start_date.to_date) %> au <%= l(@end_date.to_date) %>
    </h3>    
</div> 

<% @vacations = intervenant.vacations.where("date BETWEEN ? AND ?", @start_date, @end_date) %>
<% @responsabilites = intervenant.responsabilites.where("debut < DATE(?) AND fin > DATE(?)", @end_date, @start_date) %>
<% cumul_hetd = cumul_vacations = cumul_resps = cumul_tarif = cumul_duree = 0 %>
<% nbr_heures_statutaire = intervenant.nbr_heures_statutaire || 0 %>

<table class="table_pdf">
    <thead>
        <th>Date</th>
        <th>Heure</th>
        <th>Formation</th>
        <th>Code</th>
        <th>Intitulé</th>
        <th>Durée</th>
        <th>CM/TD</th>
        <th>Taux</th>
        <th>HETD</th>
        <th>Montant</th>
    </thead>

    <% cours_ids.each do |id| %>
        <% c = Cour.find(id) %>
        <% unless c.hors_service_statutaire %>
            <% cumul_hetd += c.HETD %>
            <% montant_service = (c.HETD * Cour.Tarif).round(2) %>
            <% cumul_tarif += montant_service %>
        <% end %>
        <% cumul_duree += c.duree %> 
        <% formation = Formation.unscoped.find(c.formation_id) %>
        <tr>
            <td><%= l(c.debut.to_date) %></td>
            <td style="text-align: right;"><%= c.debut.strftime("%k:%M") %></td>
            <td><%= formation.abrg %></td>
            <td><%= formation.Code_Analytique_avec_indice(c) %></td>
            <td><%= c.nom_ou_ue %></td>
            <td style="text-align: right;"><%= c.duree.to_f %></td>
            <td style="text-align: center;"><%= c.CMTD? %></td>
            <td style="text-align: right;"><%= c.Taux_TD %></td>
            <td style="text-align: right;"><%= c.HETD %></td>
            <td style="text-align: right;"><%= number_to_currency(montant_service) %></td>
        </tr>
    <% end %>

    <tr>
        <td colspan="5"><b>Sous-total: <%= cours_ids.count %> cours</b></td>
        <td style="text-align: right;"><b><%= cumul_duree %></b></td>
        <td colspan="2" /> 
        <td style="text-align: right;"><b><%= cumul_hetd %></b></td>
        <td style="text-align: right;"><b><%= number_to_currency(cumul_tarif) %></b></td> 
    </tr>

    <% @vacations.each_with_index do |vacation, index| %>
        <% montant_vacation = ((Cour.Tarif * vacation.forfaithtd) * vacation.qte).round(2) %>
        <% cumul_vacations += montant_vacation %>
        <% formation = Formation.unscoped.find(vacation.formation_id) %> 
        <tr>
            <td><%= l vacation.date %></td>
            <td />
            <td><%= formation.abrg %></td>
            <td><%= formation.Code_Analytique %></td>
            <td><%= vacation.titre %></td>
            <td style="text-align: right;"><%= vacation.qte %></td>
            <td colspan="2">
            <td style="text-align: right;"><%= vacation.forfaithtd %></td>
            <td style="text-align: right;"><%= number_to_currency(montant_vacation) %></td>
        </tr>

        <% if index == @vacations.size - 1 %>
            <tr>
                <td colspan="9">
                    <b>Sous-total: <%= pluralize(@vacations.count, 'vacation') %></b>
                </td>
                <td style="text-align: right;">
                    <b><%= number_to_currency(cumul_vacations) %></b>
                </td>
            </tr>
        <% end %>
    <% end %>

    <% @responsabilites.each_with_index do |resp, index| %>
        <% montant_responsabilite = (resp.heures * Cour.Tarif).round(2) %>
        <% cumul_resps += montant_responsabilite %>
        <tr>
            <td><%= l resp.debut %></td>
            <td><%= l resp.fin %></td>
            <td><%= resp.formation.abrg %></td>
            <td><%= resp.formation.Code_Analytique %></td>
            <td><%= resp.titre %></td>
            <td style="text-align: right;"><%= resp.heures %></td>
            <td colspan="3" />
            <td style="text-align: right;"><%= number_to_currency(montant_responsabilite) %></td>
        </tr>
        <% if index == @responsabilites.size - 1 %>
            <tr>
                <td colspan="9">
                    <b>Sous-total: <%= pluralize(@responsabilites.count, 'responsabilité') %></b>
                </td>
                <td style="text-align: right;">
                    <b><%= number_to_currency(cumul_resps) %></b>
                </td>
            </tr>
        <% end %>
    <% end %>

    <tfoot>
        <td colspan="9" class="text-center">
            <b>TOTAL</b>
            <% if nbr_heures_statutaire > 0 %>
                <i>
                    Nbr Heures Statutaires: 
                    <%= number_with_precision(nbr_heures_statutaire, precision:1) %>h
                    <% if (nbr_heures_statutaire > 0) && (cumul_hetd >= nbr_heures_statutaire) %>
                        | Dépassement: 
                        <%= number_with_precision((cumul_hetd - nbr_heures_statutaire) , precision:1) %>h
                    <% end %>
                </i>
            <% end %>
        </td>
        <td style="text-align: right;">
            <b><%= number_to_currency(cumul_resps + cumul_vacations + cumul_tarif ) %></b>
        </td>
    </tfoot>
</table>
