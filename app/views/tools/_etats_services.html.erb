<% cours_ids = @cours.where(intervenant: intervenant).order(:debut).pluck(:id) %>
<% cours_ids << @cours.where(intervenant_binome: intervenant).order(:debut).pluck(:id) %>
<% cours_ids = cours_ids.flatten %>

<% if cours_ids %>
    <div class="page-header"> 
        <h2><%= link_to intervenant.nom_prenom, intervenant %></h2>
    </div> 

    <% @vacations = intervenant.vacations.where("date BETWEEN ? AND ?", @start_date, @end_date) %>
    <% @responsabilites = intervenant.responsabilites.where("debut < DATE(?) AND fin > DATE(?)", @end_date, @start_date) %>
    <% cumul_hetd = cumul_vacations = cumul_resps = cumul_tarif = cumul_duree = 0 %>
    <% nbr_heures_statutaire = intervenant.nbr_heures_statutaire || 0 %>

    <table class="table table-hover table-striped table-bordered">
        <thead>
            <th>Date</th>
            <th>Heure</th>
            <th>Formation</th>
            <th>Code</th>
            <th>Intitulé</th>
            <th></th>
            <th>Durée</th>
            <th>CM/TD</th>
            <th>Taux</th>
            <th>HETD</th>
            <th style="width: 100px;">Montant</th>
            <th>Cumul_HETD</th>
        </thead>

        <% cours_ids.each do |id| %>
            <% c = Cour.find(id) %>
            <% cumul_duree += c.duree %> 
            <% formation = Formation.unscoped.find(c.formation_id) %>

            <% unless c.hors_service_statutaire || formation.hss %>
                <% cumul_hetd += c.HETD %>
                <% montant_service = (c.HETD * Cour.Tarif).round(2) %>
                <% cumul_tarif += montant_service %>
            <% end %>

            <tr>
                <td><%= link_to l(c.debut.to_date), cours_path(start_date:c.debut.to_date) %></td>
                <td class="text-right"><%= c.debut.strftime("%k:%M") %></td>
                <td><%= link_to formation.abrg, formation_path(formation), target:"_new", title: formation.nom_promo %></td>
                <td><%= formation.Code_Analytique_avec_indice(c) %></td>
                <td><%= link_to "#{c.ue} #{c.nom_ou_ue}", edit_cour_path(c), target:"_new" %></td>
                <td class="text-center">
                    <% unless c.commentaires.blank? %>
                        <span class="glyphicon Soutenance de Sarah PELLERIN  glyphicon-comment" title="<%= c.commentaires %>" />
                    <% end %>
                    <% if c.elearning %>
                        <span class="glyphicon glyphicon-home" />
                    <% end %>
                    <% if c.hors_service_statutaire %>
                        <span class="glyphicon glyphicon-remove" />
                    <% end %>
                    <% if c.intervenant_id && c.intervenant_binome_id %>
                        <span class="glyphicon glyphicon-user" title="<%= c.intervenant.nom_prenom %>" />
                        <span class="glyphicon glyphicon-user" title="<%= c.intervenant_binome.nom_prenom %>" />
                    <% end %>
                </td>
                <td class="text-right"><%= c.duree.to_f %></td>
                <td class="text-center"><%= c.CMTD? %></td>
                <td class="text-right"><%= c.Taux_TD %></td>
                <td class="text-right"><%= c.HETD %></td>
                <td class="text-right"><%= number_to_currency(montant_service) %></td>
                <td class="text-right">
                    <%= cumul_hetd %>
                    <% if (nbr_heures_statutaire > 0) && (cumul_hetd >= nbr_heures_statutaire) %>
                            <i class="glyphicon glyphicon-plus-sign" />
                    <% end %>
                </td>
            </tr>
        <% end %>

        <tr>
            <th colspan="5">Total: <%= cours_ids.count %> cours</th>
            <th />
            <th class="text-right"><%= cumul_duree %></th>
            <th /><th /> 
            <th class="text-right"><%= cumul_hetd %></th>
            <th class="text-right"><%= number_to_currency(cumul_tarif) %></th> 
            <th class="text-right"><%= cumul_hetd %></th>   
        </tr>

        <% @vacations.each_with_index do |vacation, index| %>
            <% montant_vacation = ((Cour.Tarif * vacation.forfaithtd) * vacation.qte).round(2) %>
            <% cumul_vacations += montant_vacation %>
            <% formation = Formation.unscoped.find(vacation.formation_id) %> 
            <tr>
                <td><%= l vacation.date %></td>
                <td />
                <td><%= link_to formation.nom, formation, target:"_new" %></td>
                <td><%= formation.Code_Analytique %></td>
                <td><%= vacation.titre %></td>
                <td />
                <td class="text-right"><%= vacation.qte %></td>
                <td colspan="2">
                <td class="text-right"><%= vacation.forfaithtd %></td>
                <td class="text-right"><%= number_to_currency(montant_vacation) %></td>
                <td />
            </tr>

            <% if index == @vacations.size - 1 %>
                <tr>
                    <th colspan="10">Total: <%= pluralize(@vacations.count, 'vacation') %></th>
                    <th class="text-right"><%= number_to_currency(cumul_vacations) %></th>
                    <th />
                </tr>
            <% end %>
        <% end %>

        <% @responsabilites.each_with_index do |resp, index| %>
            <% montant_responsabilite = (resp.heures * Cour.Tarif).round(2) %>
            <% cumul_resps += montant_responsabilite %>
            <tr>
                <td><%= l resp.debut %></td>
                <td><%= l resp.fin %></td>
                <td><%= link_to resp.formation.nom, resp.formation, target:"_new" %></td>
                <td><%= resp.formation.Code_Analytique %></td>
                <td><%= resp.titre %></td>
                <td />
                <td class="text-right"><%= resp.heures %></td>
                <td colspan="3" />
                <td class="text-right"><%= number_to_currency(montant_responsabilite) %></td>
                <td />
            </tr>
            <% if index == @responsabilites.size - 1 %>
                <tr>
                    <th colspan="10">Total: <%= pluralize(@responsabilites.count, 'responsabilité') %></th>
                    <th class="text-right"><%= number_to_currency(cumul_resps) %></th>
                    <th />
                </tr>
            <% end %>
        <% end %>

        <tfoot>
            <th colspan="10" class="text-center">
                <% if nbr_heures_statutaire > 0 %>
                    <i>
                        Nbr Heures Statutaires: 
                        <%= number_with_precision(nbr_heures_statutaire, precision:1) %>h
                        <% if (nbr_heures_statutaire > 0) && (cumul_hetd >= nbr_heures_statutaire) %>
                            | Dépassement: 
                            <%= number_with_precision((cumul_hetd - nbr_heures_statutaire) , precision:1) %>h
                        <% end %>
                    </i>
                <% end %>
            </th>
            <th class="text-right"><%= number_to_currency(cumul_resps + cumul_vacations + cumul_tarif ) %></th>
        </tfoot>
    </table>
<% end %>