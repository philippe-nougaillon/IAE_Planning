<div class="page-header">
  <% if current_user.admin? %>
    <%= link_to formations_path, class: 'btn btn-default' do %>
      <span class="glyphicon glyphicon-list-alt"></span>
      Retour
    <% end %>
    <%= link_to edit_formation_path(@formation), class: 'btn btn-primary' do %>
      <span class="glyphicon glyphicon-pencil"></span>
      Modifier
    <% end %>
  <% end %>
  
  <h2>
    <%= @formation.nom %> <%= "(#{@formation.abrg})" if @formation.abrg %>
  </h2>
</div>

<dl class="dl-horizontal"></dl>

<dir class="row">
  <dir class="col-sm-6">
    <p>
      <strong>Abr. :</strong>
      <%= @formation.abrg %>
    </p>

    <p>
      <strong>Couleur:</strong>
      <span style="background-color:<%= @formation.color %>;padding-left: 50px;margin-left: 5px"> </span>
    </p>

    <p>
      <strong>Promo:</strong>
      <%= @formation.promo %>
    </p>

    <p>
      <strong>Diplôme:</strong>
      <%= @formation.diplome %>
    </p>

    <p>
      <strong>Domaine:</strong>
      <%= @formation.domaine %>
    </p>

    <p>
      <strong>Apprentissage:</strong>
      <%= @formation.apprentissage ? "Oui" : "Non" %>
    </p>

  </dir>

  <dir class="col-sm-6">
    <p> 
      <strong>
        <%= "Hors catalogue !" if @formation.hors_catalogue %>
      </strong>
    </p>

    <p>
      <strong>Chargée de formation:</strong>
      <%= @formation.user.email if @formation.user %>
    </p>

    <p>
      <strong>Nbr étudiants prévus:</strong>
      <%= @formation.nbr_etudiants %>
    </p>
     
    <p>
      <strong>Nbr d'heures prévues:</strong>
      <%= @formation.nbr_heures %>
      (
        Planifiées:
        <%= link_to @formation.cours.planifié.sum(:duree), 
        cours_path(formation_id:@formation, etat:Cour.etats[:planifié])  %>
      )
    </p>

    <p>
      <strong>Nbr d'utilisateurs associés:</strong>
      <%= link_to @formation.users.count, users_path(formation_id: @formation.id) %>
    </p>

    <p>
      <strong>Mémo:</strong>
      <%= @formation.memo %>
    </p>
  </dir>
</dir>


<h3>Unités d'enseignements</h3>
<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>Code</th>
        <th>Intitulé</th>
        <th>Cours</th>
        <th>Heures</th>
      </tr>
    </thead>

    <tbody>
      <% total_ue = total = 0.0 %>
      <%= content_tag_for(:tr, @formation.unites) do | unite | %>
        <% cours = @formation.cours.where(ue:unite.num) %>
        <td><%= link_to unite.num, cours_path(formation_id:@formation, ue:unite.num) %></td>
        <td><%= unite.nom %></td>
        <td><%= link_to cours.count, cours_path(formation_id:@formation, ue:unite.num, filter:'all') %></td>
        <td><%= total = cours.sum(:duree) %></td>
        <% total_ue += total %>
      <% end %>
    </tbody>

    <tfoot>
      <tr>
        <th /><th /><th />
        <th><%= total_ue %></th>
      </tr>
    </tfoot>  
  </table>
</div>

<% if @formation.documents.any? %>
  <h3>Documents liés</h3>
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>Nom</th>
          <th>UE</th>
          <th>Publié par</th>
        </tr>
      </thead>

      <tbody>
        <%= content_tag_for(:tr, @formation.documents) do |document| %>
            <td><%= link_to document.nom, document.fichier.url %></td>
            <td><%= document.unite.num_nom %></td>
            <td><%= document.intervenant.nom_prenom %></td>
        <% end %>
      </tbody>

      <tfoot>
        <tr>
          <th /><th /><th />
        </tr>
      </tfoot>  

    </table>
  </div>
<% end %>

<% if current_user.admin? %>
  <% if @formation.audits.any? %>
    <h3>Historique des modifications</h3>
    <table class="table table-condensed">
      <% @formation.audits.includes(:user).reverse.each do |audit| %>
        <tr>
          <td><%= l(audit.created_at, format: :short) %></td>
          <td><%= audit.user.email if audit.user %></td>
          <td><%= audit.action %></td>
          <td><%= audit.audited_changes %></td>
        </tr>  
      <% end %>
    </table>
  <% end %>
<% end %>